<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Http.sys Delegation </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Http.sys Delegation ">
    <meta name="generator" content="docfx 2.59.4.0">
    
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="httpsys-delegation">Http.sys Delegation</h1>

<h2 id="introduction">Introduction</h2>
<p>Http.sys delegation is a kernel level feature added into newer versions of Windows which allows a request to be transferred from the receiving process's http.sys queue to a target process's http.sys queue with very little overhead or added latency. For this delegation to work, the receiving process is only allowed to read the request headers. If the body has started to be read or a response has started, trying to delegate the request will fail. The response will not be visible to the proxy after delegation, which limits the functionality of the session affinity and passive health checks components, as well as some of the load balancing algorithms. Internally, YARP leverage's ASP.NET Core's <a href="https://docs.microsoft.com/dotnet/api/microsoft.aspnetcore.server.httpsys.ihttpsysrequestdelegationfeature">IHttpSysRequestDelegationFeature</a></p>
<h2 id="requirements">Requirements</h2>
<p>Http.sys delegation requires:</p>
<ul>
<li>ASP.NET Core 6+</li>
<li><a href="https://docs.microsoft.com/aspnet/core/fundamentals/servers/httpsys">ASP.NET Core's Http.sys server</a></li>
<li>Windows Server 2019 or Windows 10 (build number 1809) or newer.</li>
</ul>
<h2 id="defaults">Defaults</h2>
<p>Http.sys delegation won't be used unless added to the proxy pipeline and enabled in the destination configuration.</p>
<h2 id="configuration">Configuration</h2>
<p>Http.sys delegation can be enabled per destination by adding the <code>HttpSysDelegationQueue</code> metadata to the destination. The value of this metadata should be the target http.sys queue name. The destination's Address is used to specify the url prefix of the http.sys queue.</p>
<pre><code class="lang-json">{
  &quot;ReverseProxy&quot;: {
    &quot;Routes&quot;: {
      &quot;route1&quot; : {
        &quot;ClusterId&quot;: &quot;cluster1&quot;,
        &quot;Match&quot;: {
          &quot;Path&quot;: &quot;{**catch-all}&quot;
        },
      }
    },
    &quot;Clusters&quot;: {
      &quot;cluster1&quot;: {
        &quot;Destinations&quot;: {
          &quot;cluster1/destination1&quot;: {
            &quot;Address&quot;: &quot;http://*:80/&quot;,
            &quot;Metadata&quot;: {
              &quot;HttpSysDelegationQueue&quot;: &quot;TargetHttpSysQueueName&quot;
            }
          }
        }
      }
    }
  }
}
</code></pre>
<p>In host configuration, configure the host to use the Http.sys server.</p>
<pre><code class="lang-c#">webBuilder.UseHttpSys();
</code></pre>
<p>In application configuration, use the <code>MapReverseProxy</code> overload that lets you customize the pipeline and add http.sys delegation by calling <code>UseHttpSysDelegation</code>.</p>
<pre><code class="lang-c#">app.MapReverseProxy(proxyPipeline =&gt;
{
    // Add the three middleware YARP adds by default plus the Http.sys delegation middleware
    proxyPipeline.UseSessionAffinity(); // Has no affect on delegation destinations
    proxyPipeline.UseLoadBalancing();
    proxyPipeline.UsePassiveHealthChecks();
    proxyPipeline.UseHttpSysDelegation();
});
</code></pre>
<h2 id="delegation-queue-lifetime">Delegation Queue Lifetime</h2>
<p>When YARP is configured to use delegation for a destination, a handle is created to the specified http.sys queue. This handle is kept alive as long as the destinations referencing it exist. Clean up of these handles is done during GC, so it's possible cleanup of the handle is delayed if it ends up in Gen2. This may cause issues for some receivers during process restart because if they try to create the queue during startup it will fail (because it still exists since YARP has a handle to it). The receivers need to be smart enough to attach instead and propertly re-setup the queue. ASP.NET Core's http.sys server <a href="https://github.com/dotnet/aspnetcore/issues/40359">has this issue</a>.</p>
<p>YARP exposes a way to reset its handle to the queue. This allows consumers to write custom logic to determin if/when the handle to the queue should be cleaned up.</p>
<p>Example:</p>
<pre><code class="lang-c#">var delegator = app.Services.GetRequiredService&lt;IHttpSysDelegator&gt;();
delegator.ResetQueue(&quot;TargetHttpSysQueueName&quot;, &quot;http://*:80&quot;);
</code></pre>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/microsoft/reverse-proxy/blob/release/latest/docs/docfx/articles/httpsys-delegation.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
